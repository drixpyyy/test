<!DOCTYPE html>
<html>
<head>
    <title>GitHub Streamer</title>
    <style>
        body { background: #111; color: white; font-family: sans-serif; text-align: center; }
        input, select, button { padding: 10px; margin: 5px; background: #222; color: #fff; border: 1px solid #555; }
        #status { color: #0f0; }
    </style>
</head>
<body>
    <h1>GitHub Screen Relay</h1>
    <input type="password" id="token" placeholder="GitHub Personal Access Token">
    <input type="text" id="repo" placeholder="username/repo_name">
    <br>
    <select id="quality">
        <option value="20">140p (20px)</option>
        <option value="40">320p (40px)</option>
        <option value="80">720p (80px)</option>
    </select>
    <button onclick="start()">Start Stream</button>
    <p id="status">Status: Idle</p>

    <script>
        let video = document.createElement('video');
        let sha = ""; // Needed for GitHub API updates

        async function start() {
            const stream = await navigator.mediaDevices.getDisplayMedia({video: true});
            video.srcObject = stream; video.play();
            document.getElementById('status').innerText = "Streaming... (Expect 1-3 min delay)";
            setInterval(uploadFrame, 5000); // Only update every 5s to avoid GitHub ban
        }

        async function uploadFrame() {
            const canvas = document.createElement('canvas');
            const w = document.getElementById('quality').value;
            const h = Math.floor(w * 0.56);
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, w, h);
            const pix = ctx.getImageData(0,0,w,h).data;
            
            let frame = [];
            for(let y=0; y<h; y++) {
                let row = [];
                for(let x=0; x<w; x++) {
                    let i = (y*w+x)*4;
                    row.push([pix[i], pix[i+1], pix[i+2]]);
                }
                frame.push(row);
            }

            const token = document.getElementById('token').value;
            const repo = document.getElementById('repo').value;
            const url = `https://api.github.com/repos/${repo}/contents/data.json`;

            // Get current SHA to overwrite file
            const getFile = await fetch(url, {headers: {Authorization: `token ${token}`}});
            const fileData = await getFile.json();
            sha = fileData.sha;

            // Upload new data
            fetch(url, {
                method: "PUT",
                headers: { Authorization: `token ${token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: "update frame",
                    content: btoa(JSON.stringify(frame)),
                    sha: sha
                })
            });
        }
    </script>
</body>
</html>
